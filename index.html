<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Tax Invoice</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: ltr;
      background: #f9f9f9;
      padding: 0;
      margin: 0;
    }

    .page-container {
      display: flex;
      gap: 20px;
      padding: 20px;
      align-items: flex-start;
    }

    .invoice-container {
      flex: 1;
      min-width: 0;
    }

    .saved-invoices-panel {
      width: 300px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .saved-invoices-panel h3 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
      color: #234082;
    }

    button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 12px;
      direction: ltr;
    }

    td textarea {
      font-weight: bold;
      width: 100%;
      min-height: 40px;
      resize: none;
      overflow: hidden;
      word-wrap: break-word;
      white-space: pre-wrap;
      box-sizing: border-box;
      line-height: 1.4;
    }

    .invoice {
      background: url('https://cdn.shopify.com/s/files/1/0636/1035/5827/files/2.png') no-repeat center;
      background-size: contain;
      background-color: #ffffff;
      max-width: 900px;
      margin: auto;
      position: relative;
      padding: 5px 40px 20px 40px;
    }

    .header {
      background: url('https://cdn.shopify.com/s/files/1/0636/1035/5827/files/1.jpg') no-repeat center top;
      background-size: cover;
      height: 150px;
      position: relative;
    }

    .header-info {
      position: absolute;
      font-weight: bold;
      top: 115px;
      margin-top: -9px;
      bottom: 10px;
      left: 20px;
      color: #000;
      font-size: 12px;
    }

    .date-info {
      position: absolute;
      top: 79px;
      bottom: 10px;
      left: 20px;
      color: #fff;
      font-size: 12px;
    }

    .user-info {
      position: absolute;
      top: 10px;
      right: 40px;
      color: #fff;
      font-size: 12px;
      text-align: right;
    }

    .delete-btn {
      background-color: transparent;
      color: red;
      border: none;
      font-size: 12px;
      cursor: pointer;
    }

    .delete-invoice-btn {
      background: none;
      color: #f44336;
      border: none;
      font-size: 12px;
      cursor: pointer;
      padding: 5px;
    }

    .action-buttons {
      margin-top: 15px;
    }

    .invoice-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      margin-right: 10px;
      cursor: pointer;
    }

    .footer {
      background: url('') no-repeat center bottom;
      background-size: contain;
      height: 120px;
      bottom: 0;
      left: 0;
      width: 100%;

    }

    .section {
      margin: 0px 0;
    }
    .trapezoid {
      position: absolute;
      width: 420px;
      height: 60px;
      top: 98px;
      bottom: 10px;
      left: 480px;
      background-color: #fff; /* Main blue */
      clip-path: polygon(10% 0, 100% 0, 100% 100%, 0% 100%); /* Cut left slant */
    }
    .contact-info {
      padding: 3px 0px 0px 100px;
      display: flex;
      align-items: center;
      gap: 30px; /* Space between WhatsApp and Email */
      font-size: 14px;
    }
    .contact-item {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: #1d3e78;
    }
    .contact-item i {
      
      font-size: 22px;
    }
    
    .se {
      position: absolute;
      top: 60px;
      bottom: 10px;
      left: 717px;
      color: #fff;
      font-size: 12px;
    }
 .sec {
      position: absolute;
      top: 0px;
      bottom: 10px;
      left: 30px;
      color: #fff;
    }

    .section h3 {
      margin-top: 0px;
      margin-bottom: 5px;
    }

    td input {
      width: 100%;
      font-size: 15px;
      background: transparent;
      border: none;
      resize: vertical;
      box-sizing: border-box;
      white-space: normal;
      word-wrap: break-word;
      font-weight: bold;
    }

    .tablec {
      padding: 1px;
      text-align: center;
      background-color: #234082;
      color: #fff;
    }

    .tableb {
      padding: 5px 15px;
      text-align: left;
      background-color: #234082;
      color: #fff;
      width: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

     .tabled {
      
      text-align: left;
      color: #234082;
      width: 260px;
    }
.tabledx {
      margin-top: 15px;
      text-align: left;
      color: #fffff;
      width: 260px;
     font-size:24px;
    }
 .tabledin {
      padding: 15px;
      text-align: left;
      color: #fffff;
      width: 260px;
     font-size:14px;
    }

    table {
      table-layout: auto;
      word-wrap: break-word;
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
    }

    th, td {
      border: 1px solid #000000;
      padding: 1px 8px;
      font-weight: bold;
      text-align: center;
    }


    .b-details {
      padding: 5px;
      flex: 1 1 50%;
    }
    .bank-details {
      margin-top: 15px;
      font-weight: bold;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 5px;
      flex: 1 1 63%;
    }
    

    .summary {
      font-weight: bold;
      padding: 5px;
      flex: 1 1 50%;
    }

    .totals td {
      font-weight: bold;
      padding: 10px;
      text-align: center;
    }

    .signature {
      font-weight: bold;
      margin-top: 0px;
      text-align: left;
    }

    .details-section {
      margin-top: 25px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .client-details,
    .project-details {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 5px;
      flex: 1 1 45%;
    }

    #invoiceList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #invoiceList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: #f5f5f5;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #invoiceList li:hover {
      background: #e0e0e0;
    }

   @media (max-width: 1200px) {
      .page-container {
        flex-direction: column;
      }

      .saved-invoices-panel {
        width: auto;
        position: static;
      }
    }

    @media print {
      .no-export,
      .saved-invoices-panel {
        display: none !important;
      }
    }

    .export-pdf .no-export,
    .export-pdf .saved-invoices-panel {
      display: none !important;
    }
    /* Add these to your existing style section */
@media print {

  td textarea {
    height: auto !important;
    overflow: visible !important;
  }
}



/* Ensure consistent text sizing */
.export-pdf textarea,
.export-pdf input {
  font-size: 14px !important;
  line-height: 1.4 !important;
}
  </style>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="page-container">
  <div class="invoice-container">
    <div class="invoice">
      <div id="invoice">
        <!-- Add this inside the body somewhere -->
<span id="currentUser" style="display:none;">System User</span>
<span id="currentDateTime" style="display:none;">N/A</span>

        <div class="header">
         <div class="se">
            <h3 class="tabled">TRN: 100511224600003</h3>
        </div>
          <div class="trapezoid">
             <div class="contact-info">
  <a href="https://wa.me/97126416009" class="contact-item" target="_blank">
    <i class="fab fa-whatsapp"></i>
    +971 2 641 6009
  </a>

  <a href="mailto:info@kon-uae.com" class="contact-item">
    <i class="fas fa-envelope"></i>
    info@kon-uae.com
  </a>
</div>
            <div class="contact-info">
  <a href="https://maps.google.com/?q=24.440023,54.412598" class="contact-item" target="_blank">
    <i class="fas fa-map-marker-alt"></i>
    6, Al Milaysa St
Hadbat Al Za'faranah, AD
  </a>
</div>
            
          </div>
         <div class="sec">
            <h3 class="tabledx">TAX INVOICE</h3>
        </div>
          
          <div class="date-info">
            <label style="color:white; width:200px; font-size:12px;font-weight: bold;">Date: <input style="color:white; width:200px; font-size:12px;font-weight: bold; background:transparent; border-color:transparent;" type="txt" id="invoiceDate"></label>
          </div>
          <div class="header-info">
            <label>Reference: <input style="width:400px; font-size:12px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="reference"></label>
            <p>Invoice Number: <input style="width:300px; font-size:12px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="invoiceNumber"></p>
          </div>
        </div>

     
 

       <div class="section details-section">
          <div class="client-details">
            <h3 class="tableb">Client Details</h3>
            <p style="margin-bottom: 0px;">
             <input style="width:400px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" value="Name/Reference:" id="clientName">
               <input style="width:400px; margin-left: 5px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="clientName1">
            </p>
            <p style="margin-top: 0px; margin-bottom: 0px;">
               <input style="width:400px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" value="Att./Email:" id="attEmail">
<input style="width:430px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="attEmail1">
<input style="width:430px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="attEmail2">
<input style="width:430px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="attEmail3">
            </p>
            <p style="margin-top: 15px;">
              <input style="width:400px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" value="LPO Number:" id="lpoNumber">
              
              
            </p>
          </div>

          <div class="project-details">
            <h3 class="tableb">Project Details</h3>
            <p style="margin-bottom: 0px;">
            
<input style="width:400px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" value="Project Name/Ref:" id="projectName">
<input style="width:420px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="projectName1">
<input style="width:420px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="projectName2">
            </p>
            <p style="margin-top: 25px;">
              
              <input style="width:400px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" value="Location:" type="text" id="location">
<input style="width:400px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="location1">
            </p>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <div class="section" id="invoiceBox">
            <h3 style="font-size:14px; margin-top: 15px;">Item Details</h3>
            <table id="itemsTable">
              <thead class="tablec">
                <tr>
                  <th>Description</th>
                  <th>Unit</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>Total</th>
                  <th class="no-export">Delete</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody"></tbody>
            </table>
            <button id="addItemBtn" class="no-export">‚ûï Add Item</button>
            <table>
                <tbody style=""><tr><td>TOTAL</td><td id="subtotal">AED 0.00</td></tr>
               </tbody></table>
          </div>

             
              
            
            
            <div class="summary">
              <h3 style="font-size:14px;">Summary</h3>
              <table>
                <tbody><tr hidden><td>Subtotal</td><td id="subtotal">AED 0.00</td></tr>
                <tr class="no-export">
                  <td>Discount Item</td>
                  <td>
                    <input style="width:auto; font-size:18px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="text" id="discountDescription" placeholder="Discount Name">
                    <input style="width:auto; font-size:18px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="text" id="discountValue" placeholder="Value" value="0">
                    <button id="addDiscountBtn">‚ûñ Add</button>
                  </td>
                </tr>
                </tbody><tbody id="discountItemsBody"></tbody>
                <tbody><tr hidden><td>Grand Total</td><td id="grandTotal">AED 0.00</td></tr>
                <tr class="no-export">
                  <td>Additional Item</td>
                  <td>
                    <input style="width:auto; font-size:18px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="text" id="extraDescription" placeholder="Item Name">
                    <input style="width:auto; font-size:18px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="text" id="extraValue" placeholder="Value" value="0">
                    <button id="addExtraBtn">‚ûï Add</button>
                  </td>
                </tr>
                </tbody><tbody id="extraItemsBody"></tbody>
                <tbody><tr><td>VAT (5%)</td><td id="tax">AED 0.00</td></tr>
                </tbody><tbody id="extraFields"></tbody>
                <tbody><tr class="tablec"><td> <input style="font-weight: bold; background:transparent; text-align: center; color:#fff; border-color:transparent;" value="Amount Due Today"></td><td id="amountDueToday">AED 0.00</td></tr>
              </tbody></table>
            </div>
        
 <div class="bank-details">
              <p>Please make the payment via check payable to KON General Contracting L.L.C or transfer to:</p>
              <p>Account Name: Kon General Contracting L.L.C</p>
              <p>Account No: 0012100092001</p>
              <p>IBAN: AE430410000012100092001</p>
              <p>Bank: Sharjah Islamic Bank</p>
            </div>
          
          <div class="signature">
            <p>Presented By:</p>
            <strong style="font-size:14px;">KON General Contracting</strong>
          </div>

          <div class="action-buttons no-export">
            <button class="invoice-btn" id="saveBtn">üíæ Save Invoice</button>
            <button class="invoice-btn" id="exportBtn">üìÑ Export PDF</button>
            <button class="invoice-btn" id="printBtn">üñ®Ô∏è Print</button>
            <button class="delete-btn" id="clearBtn">üßπ Clear Form</button>
          </div>
        </div>
        <div class="footer"></div>
      </div>
    </div>
  </div>

  <div class="saved-invoices-panel no-export">
    <h3>Saved Invoices</h3>
    <ul id="invoiceList"></ul>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// Initialize jsPDF
const { jsPDF } = window.jspdf;

// Set current date and time
const date = new Date();

let day = date.getDate();
let month = date.getMonth() + 1;
let year = date.getFullYear();

let currentDate = `${day}/${month}/${year}`;
console.log(currentDate);

// Helper function for formatting numbers with commas, no .00 unless user adds decimals
function formatNumberWithCommas(val) {
  if (val === "" || val === null || isNaN(val)) return "";
  const valStr = String(val);
  if (valStr.includes(".")) {
    let [intPart, decPart] = valStr.split(".");
    intPart = Number(intPart).toLocaleString();
    // Keep only up to first two decimal digits entered by user
    decPart = decPart ? decPart.substring(0, 2) : "";
    // Remove trailing zero if user types e.g. .00 or .10 etc -- but keep user-typed formatting
    return decPart.length > 0 ? `${intPart}.${decPart}` : intPart;
  }
  return Number(val).toLocaleString();
}

// Format input as user types (no .00 unless user adds it)
function parseAndFormatInput(e) {
  let val = e.target.value.replace(/,/g, "");
  if (val === "") {
    e.target.value = "";
    return;
  }
  if (val.includes(".")) {
    let [intPart, decPart] = val.split(".");
    intPart = intPart === "" ? "0" : intPart;
    let formatted = Number(intPart).toLocaleString();
    if (typeof decPart !== "undefined") {
      decPart = decPart.substring(0, 2); // max 2 decimals
      e.target.value = decPart.length > 0 ? `${formatted}.${decPart}` : formatted;
    } else {
      e.target.value = formatted;
    }
  } else {
    let num = parseFloat(val);
    if (!isNaN(num)) {
      e.target.value = formatNumberWithCommas(num);
    }
  }
}

// Initialize variables
let itemId = 0;
const itemsBody = document.getElementById("itemsTableBody");
const extraItemsBody = document.getElementById("extraItemsBody");
const discountItemsBody = document.getElementById("discountItemsBody");
const subtotalEl = document.getElementById("subtotal");
const taxEl = document.getElementById("tax");
const grandTotalEl = document.getElementById("grandTotal");
const amountDueTodayEl = document.getElementById("amountDueToday");
const saveBtn = document.getElementById("saveBtn");
const exportBtn = document.getElementById("exportBtn");
const printBtn = document.getElementById("printBtn");
const clearBtn = document.getElementById("clearBtn");

let extraFields = [];

// Update timestamp every second
function updateDateTime() {
  const now = new Date();
  const formatted = now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
  document.getElementById('currentDateTime').textContent = formatted;
}
setInterval(updateDateTime, 1000);

function createItemRow(description = "", unit = "", quantity = 1, price = 0, total = 0) {
  const row = document.createElement("tr");
  row.classList.add("invoice-item");
  row.innerHTML = `
    <td><textarea class="desc" style="font-size: 14px;width: 100%; background:transparent; border-color:transparent; resize: both;">${description}</textarea></td>
    <td><input style="text-align: center; width: 60px;" value="${unit}" class="unit"></td>
    <td><input style="text-align: center; width: 60px;" type="text" value="${formatNumberWithCommas(quantity)}" class="qty"></td>
    <td><input style="text-align: center; width: 60px;" type="text" value="${formatNumberWithCommas(price)}" class="price"></td>
    <td class="total">${formatNumberWithCommas(total)}</td>
    <td class="no-export"><button class="delete-btn">‚ùå</button></td>
  `;

  row.querySelector(".delete-btn").addEventListener("click", () => {
    row.remove();
    calculateTotals();
  });

  // Format quantity and price on input, and recalculate
  [".qty", ".price"].forEach(cls => {
    let input = row.querySelector(cls);
    input.addEventListener("input", (e) => {
      parseAndFormatInput(e);
      calculateTotals();
    });
  });

  row.querySelector(".desc").addEventListener("input", calculateTotals);
  row.querySelector(".unit").addEventListener("input", calculateTotals);

  itemsBody.appendChild(row);
  calculateTotals();
}

function calculateTotals() {
  let subtotal = 0;
  itemsBody.querySelectorAll("tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".qty").value.replace(/,/g, "")) || 0;
    const price = parseFloat(row.querySelector(".price").value.replace(/,/g, "")) || 0;
    const total = qty * price;
    row.querySelector(".total").textContent = ` ${formatNumberWithCommas(total)}`;
    subtotal += total;
  });

  subtotalEl.textContent = `AED ${formatNumberWithCommas(subtotal)}`;

  let extra = 0;
  extraItemsBody.querySelectorAll("tr").forEach(row => {
    const val = parseFloat(row.getAttribute("data-value").replace(/,/g, "")) || 0;
    extra += val;
  });

  let discount = 0;
  discountItemsBody.querySelectorAll("tr").forEach(row => {
    const val = parseFloat(row.getAttribute("data-value").replace(/,/g, "")) || 0;
    discount += val;
  });

  const grandTotal = subtotal - discount;
  grandTotalEl.textContent = `AED ${formatNumberWithCommas(grandTotal)}`;

  // --- NEW LOGIC: If there are additional items, VAT & Amount Due Today are calculated from them only ---
  let vatBase = extra > 0 ? extra : grandTotal;
  let tax = vatBase * 0.05;
  let amountDueToday = vatBase + tax;

  taxEl.textContent = `AED ${formatNumberWithCommas(tax)}`;
  amountDueTodayEl.textContent = `AED ${formatNumberWithCommas(amountDueToday)}`;
}

function getInvoiceData() {
  return {
    id: `INV-${Date.now()}`,
    date: document.getElementById('invoiceDate').value,
    reference: document.getElementById('reference').value,
    invoiceNumber: document.getElementById('invoiceNumber').value,
    clientName: document.getElementById('clientName').value,
    clientName1: document.getElementById('clientName1').value,
    attEmail: document.getElementById('attEmail').value,
    attEmail1: document.getElementById('attEmail1').value,
    attEmail2: document.getElementById('attEmail2').value,
    attEmail3: document.getElementById('attEmail3').value,
    lpoNumber: document.getElementById('lpoNumber').value,
    projectName: document.getElementById('projectName').value,
    projectName1: document.getElementById('projectName1').value,
    projectName2: document.getElementById('projectName2').value,
    location: document.getElementById('location').value,
    location1: document.getElementById('location1').value,

    items: Array.from(document.querySelectorAll("#itemsTableBody tr")).map(row => ({
      description: row.querySelector(".desc").value,
      unit: row.querySelector(".unit").value,
      quantity: parseFloat(row.querySelector(".qty").value.replace(/,/g, "")) || 0,
      price: parseFloat(row.querySelector(".price").value.replace(/,/g, "")) || 0,
    })),

    extraItems: Array.from(extraItemsBody.querySelectorAll('tr')).map(row => ({
      name: row.querySelector('td').textContent,
      value: parseFloat(row.getAttribute('data-value'))
    })),
    discountItems: Array.from(discountItemsBody.querySelectorAll('tr')).map(row => ({
      name: row.querySelector('td').textContent,
      value: parseFloat(row.getAttribute('data-value'))
    })),
    createdBy: document.getElementById('currentUser').textContent,
    createdAt: document.getElementById('currentDateTime').textContent
  };
}


function loadInvoiceData(data) {
  // Clear the form but do NOT add a new item row automatically
  document.getElementById('invoiceDate').value = '';
  document.getElementById('reference').value = '';
  document.getElementById('invoiceNumber').value = '';
  document.getElementById('clientName').value = '';
  document.getElementById('clientName1').value = '';
  document.getElementById('attEmail').value = '';
  document.getElementById('attEmail1').value = '';
  document.getElementById('attEmail2').value = '';
  document.getElementById('attEmail3').value = '';
  document.getElementById('lpoNumber').value = '';
  document.getElementById('projectName').value = '';
  document.getElementById('projectName1').value = '';
  document.getElementById('projectName2').value = '';
  document.getElementById('location').value = '';
  document.getElementById('location1').value = '';
  itemsBody.innerHTML = '';
  extraItemsBody.innerHTML = '';
 discountItemsBody.innerHTML = '';

  document.getElementById('invoiceDate').value = data.date || '';
  document.getElementById('reference').value = data.reference || '';
  document.getElementById('invoiceNumber').value = data.invoiceNumber || '';
  document.getElementById('clientName').value = data.clientName || '';
 document.getElementById('clientName1').value = data.clientName1 || '';
 document.getElementById('attEmail').value = data.attEmail || '';  
 document.getElementById('attEmail1').value = data.attEmail1 || '';
 document.getElementById('attEmail2').value = data.attEmail2 || '';  
 document.getElementById('attEmail3').value = data.attEmail3 || '';
 document.getElementById('lpoNumber').value = data.lpoNumber || '';
  document.getElementById('projectName').value = data.projectName || '';
  document.getElementById('projectName1').value = data.projectName1 || '';
  document.getElementById('projectName2').value = data.projectName2 || '';
 document.getElementById('location').value = data.location || '';
 document.getElementById('location1').value = data.location1 || '';

  if (data.items && data.items.length > 0) {
    data.items.forEach(item => {
     createItemRow(item.description, item.unit, item.quantity, item.price);
   });
 }
  // Do NOT create a new empty row if there are no items

 if (data.extraItems) {
    data.extraItems.forEach(item => {
      const row = document.createElement("tr");
     row.setAttribute("data-value", item.value);
      row.innerHTML = `
        <td>${item.name}</td>       <td>
         AED ${item.value.toFixed(2)}
          <button class="delete-btn no-export">‚ùå</button>
       </td>
     `;
     row.querySelector(".delete-btn").addEventListener("click", () => {
        row.remove();
        calculateTotals();
     });
     extraItemsBody.appendChild(row);
    });
  }

 if (data.discountItems) {
   data.discountItems.forEach(item => {
     const row = document.createElement("tr");
     row.setAttribute("data-value", item.value);
     row.innerHTML = `
       <td>${item.name}</td>
       <td style="color: #ff0000">
         - AED ${item.value.toFixed(2)}
         <button class="delete-btn no-export">‚ùå</button>
      </td>
     `;
    row.querySelector(".delete-btn").addEventListener("click", () => {
      row.remove();
     calculateTotals();
  });
    discountItemsBody.appendChild(row);
 });
 }

 calculateTotals();
}

function saveInvoice() {
  const data = getInvoiceData();
  const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
  saved.push(data);
  localStorage.setItem('invoices', JSON.stringify(saved));
  loadSavedInvoices();
  alert('Invoice saved successfully ‚úÖ');
}

function createInvoiceList() {
  const list = document.createElement("ul");
  list.id = "invoiceList";
  document.querySelector(".action-buttons").after(list);
  return list;
}

function loadSavedInvoices() {
  const invoiceList = document.getElementById("invoiceList") || createInvoiceList();
  invoiceList.innerHTML = '';
  
  const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
  saved.reverse().forEach(inv => {
    const item = document.createElement("li");
    item.innerHTML = `
      <span class="invoice-meta">
        ${inv.clientName || 'Unnamed'} - ${inv.reference || inv.id}
      </span>
      <button class="delete-invoice-btn">‚ùå</button>
    `;
    
    item.querySelector(".delete-invoice-btn").addEventListener("click", (e) => {
      e.stopPropagation();
      deleteInvoice(inv.id);
    });
    
    item.addEventListener("click", () => loadInvoiceData(inv));
    invoiceList.appendChild(item);
  });
}

function deleteInvoice(id) {
  if (confirm('Are you sure you want to delete this invoice?')) {
    const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
    const filtered = saved.filter(inv => inv.id !== id);
    localStorage.setItem('invoices', JSON.stringify(filtered));
    loadSavedInvoices();
  }
}

function clearInvoice() {
  document.getElementById('invoiceDate').value = '';
  document.getElementById('reference').value = '';
  document.getElementById('invoiceNumber').value = '';
  document.getElementById('clientName').value = '';
  document.getElementById('clientName1').value = '';
  document.getElementById('attEmail').value = '';
  document.getElementById('attEmail1').value = '';
  document.getElementById('attEmail2').value = '';
  document.getElementById('attEmail3').value = '';
  document.getElementById('lpoNumber').value = '';
  document.getElementById('projectName').value = '';
  document.getElementById('projectName1').value = '';
  document.getElementById('projectName2').value = '';
  document.getElementById('location').value = '';
  document.getElementById('location1').value = '';
  itemsBody.innerHTML = '';
  extraItemsBody.innerHTML = '';
  discountItemsBody.innerHTML = '';
  createItemRow();
  calculateTotals();
}

// Event listeners
document.getElementById("addItemBtn").addEventListener("click", () => createItemRow());

document.getElementById("extraValue").addEventListener("input", parseAndFormatInput);
document.getElementById("discountValue").addEventListener("input", parseAndFormatInput);

document.getElementById("addExtraBtn").addEventListener("click", () => {
  const name = document.getElementById("extraDescription").value;
  const valInput = document.getElementById("extraValue");
  const valRaw = valInput.value.replace(/,/g, "");
  const val = parseFloat(valRaw);
  if (name && val > 0) {
    const row = document.createElement("tr");
    row.setAttribute("data-value", val);
    row.innerHTML = `
      <td>${name}</td>
      <td>
        AED ${formatNumberWithCommas(val)}
        <button class="delete-btn no-export">‚ùå</button>
      </td>
    `;
    row.querySelector(".delete-btn").addEventListener("click", () => {
      row.remove();
      calculateTotals();
    });
    extraItemsBody.appendChild(row);
    calculateTotals();
    valInput.value = "";
  }
});

document.getElementById("addDiscountBtn").addEventListener("click", () => {
  const name = document.getElementById("discountDescription").value;
  const valInput = document.getElementById("discountValue");
  const valRaw = valInput.value.replace(/,/g, "");
  const val = parseFloat(valRaw);
  if (name && val > 0) {
    const row = document.createElement("tr");
    row.setAttribute("data-value", val);
    row.innerHTML = `
      <td>${name}</td>
      <td style="color: #ff0000">
        - AED ${formatNumberWithCommas(val)}
        <button class="delete-btn no-export">‚ùå</button>
      </td>
    `;
    row.querySelector(".delete-btn").addEventListener("click", () => {
      row.remove();
      calculateTotals();
    });
    discountItemsBody.appendChild(row);
    calculateTotals();
    valInput.value = "";
  }
});

saveBtn.addEventListener("click", saveInvoice);
printBtn.addEventListener("click", () => window.print());
clearBtn.addEventListener("click", clearInvoice);

exportBtn.addEventListener("click", async () => {
  document.body.classList.add("export-pdf");

  const invoice = document.querySelector('.invoice');
  const clone = invoice.cloneNode(true);
  
  clone.querySelectorAll('textarea').forEach(textarea => {
  const div = document.createElement('div');
  
  div.style.whiteSpace = 'pre-line'; // Preserve line breaks
  div.style.fontSize = textarea.style.fontSize || '14px'; // Preserve font size
  div.style.textAlign = 'left'; // Align text to the left
  div.style.direction = 'ltr'; // Set direction to Left-To-Right
  
  div.textContent = textarea.value; // Copy text
  textarea.parentNode.replaceChild(div, textarea); // Replace textarea
  });


  const tempContainer = document.createElement('div');
  tempContainer.style.position = 'absolute';
  tempContainer.style.left = '-9999px';
  tempContainer.appendChild(clone);
  document.body.appendChild(tempContainer);

  try {
    const canvas = await html2canvas(clone, {
      scale: 2,
      logging: false,
      useCORS: true,
      allowTaint: true,
      scrollX: 0,
      scrollY: 0
    });

    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 210;
    const pageHeight = 295;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    const invoiceNumber = document.getElementById('invoiceNumber').value ||
                         'invoice';
    const reference = document.getElementById('reference').value ||
                         'invoice';                     
    pdf.save(`${reference}.pdf`);
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Error generating PDF. Please try again.');
  } finally {
    document.body.removeChild(tempContainer);
    document.body.classList.remove("export-pdf");
  }
});

function autoResizeTextarea(el) {
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight) + 'px';
}

document.addEventListener("input", function(e) {
  if (e.target.tagName.toLowerCase() === 'textarea') {
    autoResizeTextarea(e.target);
  }
});

// Initialize the form
window.onload = () => {
  createItemRow();
  loadSavedInvoices();
};
</script>
</body>
</html>

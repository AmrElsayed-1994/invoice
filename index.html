<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Tax Invoice</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: ltr;
      background: #f9f9f9;
      padding: 0;
      margin: 0;
    }

    .page-container {
      display: flex;
      gap: 20px;
      padding: 20px;
      align-items: flex-start;
    }

    .invoice-container {
      flex: 1;
      min-width: 0;
    }

    .saved-invoices-panel {
      width: 300px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .saved-invoices-panel h3 {
      margin-top: 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
      color: #234082;
    }

    button {
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 12px;
      direction: ltr;
    }

    td textarea {
      font-weight: bold;
      width: 100%;
      min-height: 40px;
      resize: none;
      overflow: hidden;
      word-wrap: break-word;
      white-space: pre-wrap;
      box-sizing: border-box;
      line-height: 1.4;
    }

    .invoice {
      background: url('https://cdn.shopify.com/s/files/1/0636/1035/5827/files/2.png') no-repeat center;
      background-size: contain;
      background-color: #ffffff;
      max-width: 900px;
      margin: auto;
      position: relative;
      padding: 5px 40px 20px 40px;
    }

    .header {
      background: url('https://cdn.shopify.com/s/files/1/0636/1035/5827/files/1.jpg') no-repeat center top;
      background-size: cover;
      height: 150px;
      position: relative;
    }

    .header-info {
      position: absolute;
      font-weight: bold;
      top: 100px;
      bottom: 10px;
      left: 40px;
      color: #000;
      font-size: 12px;
    }

    .date-info {
      position: absolute;
      top: 70px;
      bottom: 10px;
      left: 40px;
      color: #fff;
      font-size: 12px;
    }

    .user-info {
      position: absolute;
      top: 10px;
      right: 40px;
      color: #fff;
      font-size: 12px;
      text-align: right;
    }

    .delete-btn {
      background-color: transparent;
      color: red;
      border: none;
      font-size: 12px;
      cursor: pointer;
    }

    .delete-invoice-btn {
      background: none;
      color: #f44336;
      border: none;
      font-size: 12px;
      cursor: pointer;
      padding: 5px;
    }

    .action-buttons {
      margin-top: 15px;
    }

    .invoice-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      margin-right: 10px;
      cursor: pointer;
    }

    .footer {
      background: url('https://cdn.shopify.com/s/files/1/0636/1035/5827/files/3.jpg') no-repeat center bottom;
      background-size: cover;
      height: 120px;
    }

    .section {
      margin: 0px 0;
    }
    
    .se {
      position: absolute;
      top: 60px;
      bottom: 10px;
      left: 717px;
      color: #fff;
      font-size: 12px;
    }
 .sec {
      position: absolute;
      top: 0px;
      bottom: 10px;
      left: 30px;
      color: #fff;
    }

    .section h3 {
      margin-top: 0px;
      margin-bottom: 5px;
      border-bottom: 1px solid #eee;
    }

    td input {
      width: 100%;
      font-size: 12px;
      background: transparent;
      border: none;
      resize: vertical;
      box-sizing: border-box;
      white-space: normal;
      word-wrap: break-word;
      font-weight: bold;
    }

    .tablec {
      border: 1px solid #ccc;
      padding: 1px;
      text-align: center;
      background-color: #234082;
      color: #fff;
    }

    .tableb {
      padding: 5px 15px;
      text-align: left;
      background-color: #234082;
      color: #fff;
      width: auto;
      border: 1px solid #ccc;
      border-radius: 8px;
    }

     .tabled {
      
      text-align: left;
      color: #234082;
      width: 260px;
    }
.tabledx {
      
      text-align: left;
      color: #fffff;
      width: 260px;
     font-size:24px;
    }

    table {
      table-layout: auto;
      word-wrap: break-word;
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 1px;
      font-weight: bold;
      text-align: center;
    }

    .b-details {
      padding: 5px;
      flex: 1 1 50%;
    }
    .bank-details {
      margin-top: 15px;
      font-weight: bold;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 5px;
      flex: 1 1 63%;
    }
    

    .summary {
      font-weight: bold;
      padding: 5px;
      flex: 1 1 33%;
    }

    .totals td {
      font-weight: bold;
    }

    .signature {
      font-weight: bold;
      margin-top: 0px;
      text-align: left;
    }

    .details-section {
      margin-top: 25px;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .client-details,
    .project-details {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 5px;
      flex: 1 1 45%;
    }

    #invoiceList {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #invoiceList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: #f5f5f5;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #invoiceList li:hover {
      background: #e0e0e0;
    }

   @media (max-width: 1200px) {
      .page-container {
        flex-direction: column;
      }

      .saved-invoices-panel {
        width: auto;
        position: static;
      }
    }

    @media print {
      .no-export,
      .saved-invoices-panel {
        display: none !important;
      }
    }

    .export-pdf .no-export,
    .export-pdf .saved-invoices-panel {
      display: none !important;
    }
    /* Add these to your existing style section */
@media print {

  td textarea {
    height: auto !important;
    overflow: visible !important;
  }
}



/* Ensure consistent text sizing */
.export-pdf textarea,
.export-pdf input {
  font-size: 14px !important;
  line-height: 1.4 !important;
}
  </style>
</head>
<body>
<div class="page-container">
  <div class="invoice-container">
    <div class="invoice">
      <div id="invoice">
        <!-- Add this inside the body somewhere -->
<span id="currentUser" style="display:none;">System User</span>
<span id="currentDateTime" style="display:none;">N/A</span>

        <div class="header">
         <div class="se">
            <h3 class="tabled">TRN: 100511224600003</h3>
        </div>
         <div class="sec">
            <h3 class="tabledx">TAX INVOICE</h3>
        </div>
          
          <div class="date-info">
            <label style="color:white; width:200px; font-size:12px;font-weight: bold;">Date: <input style="color:white; width:200px; font-size:15px;font-weight: bold; background:transparent; padding:12px; border-color:transparent;" type="txt" id="invoiceDate"></label>
          </div>
          <div class="header-info">
            <label>Reference: <input style="width:200px; font-size:15px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="text" id="reference"></label>
            <p>Invoice Number: <input style="width:100px; font-size:15px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="invoiceNumber"></p>
          </div>
        </div>

     
 

        <div class="section details-section">
          <div class="client-details">
            <h3 class="tableb">Client Details</h3>
            <p style="margin-bottom: 0px;">
              <strong style="font-size:14px;">Name/Reference:</strong>
              <input style="width:300px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="clientName">
               <input style="width:400px; margin-left: 5px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="clientName">
            </p>
            <p style="margin-top: 0px; margin-bottom: 0px;">
              <strong style="font-size:14px;">Att./Email:</strong>
              <input style="width:350px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="attEmail">
            </p>
            <p style="margin-top: 0px;">
              <strong style="font-size:14px;">LPO Number:</strong>
              <input style="width:300px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="lpoNumber">
            </p>
          </div>

          <div class="project-details">
            <h3 class="tableb">Project Details</h3>
            <p style="margin-bottom: 0px;">
              <strong style="font-size:14px;">Project Name/Ref:</strong>
              <input style="width:300px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="projectName">
            </p>
            <p style="margin-top: 0px;">
              <strong style="font-size:14px;">Location:</strong>
              <input style="width:350px; font-size:14px; font-weight: bold; background:transparent; border-color:transparent;" type="text" id="location">
            </p>
          </div>
        </div>

        <div style="overflow-x: auto;">
          <div class="section" id="invoiceBox">
            <h3 style="font-size:14px; margin-top: 15px;">Item Details</h3>
            <table id="itemsTable">
              <thead class="tablec">
                <tr>
                  <th>Description</th>
                  <th>Unit</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>Total</th>
                  <th class="no-export">Delete</th>
                </tr>
              </thead>
              <tbody id="itemsTableBody"></tbody>
            </table>
            <button id="addItemBtn" class="no-export">➕ Add Item</button>
          </div>
 <div class="section details-section">
            
            <div class="summary">
              <h3 style="font-size:14px;">Summary</h3>
              <table>
                <tbody><tr><td>Subtotal</td><td id="subtotal">AED 0.00</td></tr>
                <tr class="no-export">
                  <td>Discount Item</td>
                  <td>
                    <input style="width:auto; font-size:18px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="text" id="discountDescription" placeholder="Discount Name">
                    <input style="width:auto; font-size:18px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="number" id="discountValue" placeholder="Value" value="0">
                    <button id="addDiscountBtn">➖ Add</button>
                  </td>
                </tr>
                </tbody><tbody id="discountItemsBody"></tbody>
                <tbody><tr><td>Grand Total</td><td id="grandTotal">AED 0.00</td></tr>
                <tr class="no-export">
                  <td>Additional Item</td>
                  <td>
                    <input style="width:auto; font-size:18px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="text" id="extraDescription" placeholder="Item Name">
                    <input style="width:auto; font-size:18px; font-weight: bold; background:transparent; padding-top:12px; border-color:transparent;" type="number" id="extraValue" placeholder="Value" value="0">
                    <button id="addExtraBtn">➕ Add</button>
                  </td>
                </tr>
                </tbody><tbody id="extraItemsBody"></tbody>
                <tbody><tr><td>VAT (5%)</td><td id="tax">AED 0.00</td></tr>
                </tbody><tbody id="extraFields"></tbody>
                <tbody><tr class="tablec"><td>Amount Due Today</td><td id="amountDueToday">AED 0.00</td></tr>
              </tbody></table>
            </div>
          </div>
 <div class="bank-details">
              <p>Please make the payment via check payable to KON General Contracting L.L.C or transfer to:</p>
              <p>Account Name: Kon General Contracting L.L.C</p>
              <p>Account No: 0012100092001</p>
              <p>IBAN: AE430410000012100092001</p>
              <p>Bank: Sharjah Islamic Bank</p>
            </div>
          
          <div class="signature">
            <p>Presented By:</p>
            <strong style="font-size:14px;">KON General Contracting</strong>
          </div>

          <div class="action-buttons no-export">
            <button class="invoice-btn" id="saveBtn">💾 Save Invoice</button>
            <button class="invoice-btn" id="exportBtn">📄 Export PDF</button>
            <button class="invoice-btn" id="printBtn">🖨️ Print</button>
            <button class="delete-btn" id="clearBtn">🧹 Clear Form</button>
          </div>
        </div>
        <div class="footer"></div>
      </div>
    </div>
  </div>

  <div class="saved-invoices-panel no-export">
    <h3>Saved Invoices</h3>
    <ul id="invoiceList"></ul>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// Initialize jsPDF
const { jsPDF } = window.jspdf;

  // Set current date and time
const date = new Date();

let day = date.getDate();
let month = date.getMonth() + 1;
let year = date.getFullYear();

// This arrangement can be altered based on how we want the date's format to appear.
let currentDate = `${day}/${month}/${year}`;
console.log(currentDate); 
  
// Initialize variables
let itemId = 0;
const itemsBody = document.getElementById("itemsTableBody");
const extraItemsBody = document.getElementById("extraItemsBody");
const discountItemsBody = document.getElementById("discountItemsBody");
const subtotalEl = document.getElementById("subtotal");
const taxEl = document.getElementById("tax");
const grandTotalEl = document.getElementById("grandTotal");
const amountDueTodayEl = document.getElementById("amountDueToday");
const saveBtn = document.getElementById("saveBtn");
const exportBtn = document.getElementById("exportBtn");
const printBtn = document.getElementById("printBtn");
const clearBtn = document.getElementById("clearBtn");

let extraFields = [];

// Update timestamp every second
function updateDateTime() {
  const now = new Date();
  const formatted = now.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
  document.getElementById('currentDateTime').textContent = formatted;
}
setInterval(updateDateTime, 1000);

function createItemRow(description = "", unit = "", quantity = 1, price = 0) {
  const row = document.createElement("tr");
  row.classList.add("invoice-item");
  row.innerHTML = `
    <td><textarea class="desc" style="font-size: 14px;width: 100%; background:transparent; border-color:transparent; resize: both;">${description}</textarea></td>
    <td><input style="text-align: center;" value="${unit}" class="unit"></td>
    <td><input style="text-align: center;" type="number" value="${quantity}" class="qty"></td>
    <td><input style="text-align: center;" type="number" value="${price}" class="price"></td>
    <td class="total">0</td>
    <td class="no-export"><button class="delete-btn">❌</button></td>
  `;

  row.querySelector(".delete-btn").addEventListener("click", () => {
    row.remove();
    calculateTotals();
  });

  [".desc", ".unit", ".qty", ".price"].forEach(cls => {
    row.querySelector(cls).addEventListener("input", calculateTotals);
  });

  itemsBody.appendChild(row);
  calculateTotals();
}

function calculateTotals() {
  let subtotal = 0;
  itemsBody.querySelectorAll("tr").forEach(row => {
    const qty = parseFloat(row.querySelector(".qty").value) || 0;
    const price = parseFloat(row.querySelector(".price").value) || 0;
    const total = qty * price;
    row.querySelector(".total").textContent = ` ${total.toFixed(2)}`;
    subtotal += total;
  });

  subtotalEl.textContent = `AED ${subtotal.toFixed(2)}`;

  let extra = 0;
  extraItemsBody.querySelectorAll("tr").forEach(row => {
    const val = parseFloat(row.getAttribute("data-value")) || 0;
    extra += val;
  });

  let discount = 0;
  discountItemsBody.querySelectorAll("tr").forEach(row => {
    const val = parseFloat(row.getAttribute("data-value")) || 0;
    discount += val;
  });

  const grandTotal = subtotal + extra - discount;
  const tax = grandTotal * 0.05;

  taxEl.textContent = `AED ${tax.toFixed(2)}`;
  grandTotalEl.textContent = `AED ${grandTotal.toFixed(2)}`;
  amountDueTodayEl.textContent = `AED ${(grandTotal + tax).toFixed(2)}`;
} 

function getInvoiceData() {
  return {
    id: `INV-${Date.now()}`,
    date: document.getElementById('invoiceDate').value,
    reference: document.getElementById('reference').value,
    invoiceNumber: document.getElementById('invoiceNumber').value,
    clientName: document.getElementById('clientName').value,
    attEmail: document.getElementById('attEmail').value,
    lpoNumber: document.getElementById('lpoNumber').value,
    projectName: document.getElementById('projectName').value,
    location: document.getElementById('location').value,
    items: Array.from(itemsBody.querySelectorAll('tr')).map(row => ({
      description: row.querySelector('.desc').value,
      unit: row.querySelector('.unit').value,
      quantity: row.querySelector('.qty').value,
      price: row.querySelector('.price').value
    })),
    extraItems: Array.from(extraItemsBody.querySelectorAll('tr')).map(row => ({
      name: row.querySelector('td').textContent,
      value: parseFloat(row.getAttribute('data-value'))
    })),
    discountItems: Array.from(discountItemsBody.querySelectorAll('tr')).map(row => ({
      name: row.querySelector('td').textContent,
      value: parseFloat(row.getAttribute('data-value'))
    })),
    createdBy: document.getElementById('currentUser').textContent,
    createdAt: document.getElementById('currentDateTime').textContent
  };
}

function loadInvoiceData(data) {
  clearInvoice();
  
  document.getElementById('invoiceDate').value = data.date || '';
  document.getElementById('reference').value = data.reference || '';
  document.getElementById('invoiceNumber').value = data.invoiceNumber || '';
  document.getElementById('clientName').value = data.clientName || '';
  document.getElementById('attEmail').value = data.attEmail || '';
  document.getElementById('lpoNumber').value = data.lpoNumber || '';
  document.getElementById('projectName').value = data.projectName || '';
  document.getElementById('location').value = data.location || '';

  if (data.items && data.items.length > 0) {
    data.items.forEach(item => {
      createItemRow(item.description, item.unit, item.quantity, item.price);
    });
  } else {
    createItemRow();
  }

  if (data.extraItems) {
    data.extraItems.forEach(item => {
      const row = document.createElement("tr");
      row.setAttribute("data-value", item.value);
      row.innerHTML = `
        <td>${item.name}</td>
        <td>
          AED ${item.value.toFixed(2)}
          <button class="delete-btn no-export">❌</button>
        </td>
      `;
      row.querySelector(".delete-btn").addEventListener("click", () => {
        row.remove();
        calculateTotals();
      });
      extraItemsBody.appendChild(row);
    });
  }

  if (data.discountItems) {
    data.discountItems.forEach(item => {
      const row = document.createElement("tr");
      row.setAttribute("data-value", item.value);
      row.innerHTML = `
        <td>${item.name}</td>
        <td>
          - AED ${item.value.toFixed(2)}
          <button class="delete-btn no-export">❌</button>
        </td>
      `;
      row.querySelector(".delete-btn").addEventListener("click", () => {
        row.remove();
        calculateTotals();
      });
      discountItemsBody.appendChild(row);
    });
  }

  calculateTotals();
}

function saveInvoice() {
  const data = getInvoiceData();
  const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
  saved.push(data);
  localStorage.setItem('invoices', JSON.stringify(saved));
  loadSavedInvoices();
  alert('Invoice saved successfully ✅');
}

function createInvoiceList() {
  const list = document.createElement("ul");
  list.id = "invoiceList";
  document.querySelector(".action-buttons").after(list);
  return list;
}

function loadSavedInvoices() {
  const invoiceList = document.getElementById("invoiceList") || createInvoiceList();
  invoiceList.innerHTML = '';
  
  const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
  saved.reverse().forEach(inv => {
    const item = document.createElement("li");
    item.innerHTML = `
      <span class="invoice-meta">
        ${inv.clientName || 'Unnamed'} - ${inv.invoiceNumber || inv.id}
      </span>
      <button class="delete-invoice-btn">❌</button>
    `;
    
    item.querySelector(".delete-invoice-btn").addEventListener("click", (e) => {
      e.stopPropagation();
      deleteInvoice(inv.id);
    });
    
    item.addEventListener("click", () => loadInvoiceData(inv));
    invoiceList.appendChild(item);
  });
}

function deleteInvoice(id) {
  if (confirm('Are you sure you want to delete this invoice?')) {
    const saved = JSON.parse(localStorage.getItem('invoices') || '[]');
    const filtered = saved.filter(inv => inv.id !== id);
    localStorage.setItem('invoices', JSON.stringify(filtered));
    loadSavedInvoices();
  }
}

function clearInvoice() {
  document.getElementById('invoiceDate').value = '';
  document.getElementById('reference').value = '';
  document.getElementById('invoiceNumber').value = '';
  document.getElementById('clientName').value = '';
  document.getElementById('attEmail').value = '';
  document.getElementById('lpoNumber').value = '';
  document.getElementById('projectName').value = '';
  document.getElementById('location').value = '';
  itemsBody.innerHTML = '';
  extraItemsBody.innerHTML = '';
  discountItemsBody.innerHTML = '';
  createItemRow();
  calculateTotals();
}

// Event listeners
document.getElementById("addItemBtn").addEventListener("click", () => createItemRow());

document.getElementById("addExtraBtn").addEventListener("click", () => {
  const name = document.getElementById("extraDescription").value;
  const val = parseFloat(document.getElementById("extraValue").value);
  if (name && val > 0) {
    const row = document.createElement("tr");
    row.setAttribute("data-value", val);
    row.innerHTML = `
      <td>${name}</td>
      <td>
        AED ${val.toFixed(2)}
        <button class="delete-btn no-export">❌</button>
      </td>
    `;
    row.querySelector(".delete-btn").addEventListener("click", () => {
      row.remove();
      calculateTotals();
    });
    extraItemsBody.appendChild(row);
    calculateTotals();
  }
});

document.getElementById("addDiscountBtn").addEventListener("click", () => {
  const name = document.getElementById("discountDescription").value;
  const val = parseFloat(document.getElementById("discountValue").value);
  if (name && val > 0) {
    const row = document.createElement("tr");
    row.setAttribute("data-value", val);
    row.innerHTML = `
      <td>${name}</td>
      <td>
        - AED ${val.toFixed(2)}
        <button class="delete-btn no-export">❌</button>
      </td>
    `;
    row.querySelector(".delete-btn").addEventListener("click", () => {
      row.remove();
      calculateTotals();
    });
    discountItemsBody.appendChild(row);
    calculateTotals();
  }
});

saveBtn.addEventListener("click", saveInvoice);
printBtn.addEventListener("click", () => window.print());
clearBtn.addEventListener("click", clearInvoice);

exportBtn.addEventListener("click", async () => {
  document.body.classList.add("export-pdf");

  const invoice = document.querySelector('.invoice');
  const clone = invoice.cloneNode(true);
  const tempContainer = document.createElement('div');
  tempContainer.style.position = 'absolute';
  tempContainer.style.left = '-9999px';
  tempContainer.appendChild(clone);
  document.body.appendChild(tempContainer);

  try {
    const canvas = await html2canvas(clone, {
      scale: 2,
      logging: false,
      useCORS: true,
      allowTaint: true,
      scrollX: 0,
      scrollY: 0
    });

    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgData = canvas.toDataURL('image/png');
    const imgWidth = 210;
    const pageHeight = 295;
    const imgHeight = canvas.height * imgWidth / canvas.width;

    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    const invoiceNumber = document.getElementById('invoiceNumber').value || 
                         document.getElementById('reference').value || 
                         'invoice';
    pdf.save(`${invoiceNumber}.pdf`);
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Error generating PDF. Please try again.');
  } finally {
    document.body.removeChild(tempContainer);
    document.body.classList.remove("export-pdf");
  }
});

function autoResizeTextarea(el) {
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight) + 'px';
}

document.addEventListener("input", function(e) {
  if (e.target.tagName.toLowerCase() === 'textarea') {
    autoResizeTextarea(e.target);
  }
});

// Initialize the form
window.onload = () => {
  createItemRow();
  loadSavedInvoices();
};
</script>
</body>
</html>
